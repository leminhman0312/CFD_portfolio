import os
from typing import Tuple
import numpy as np



# ============================================================================
# Helpers for directories
# ============================================================================
def ensure_dir(path: str) -> None:
    os.makedirs(path, exist_ok=True)


def ensure_plot_dir() -> None:
    ensure_dir("plot")


def ensure_compare_dir() -> None:
    ensure_dir("compare")


def ensure_data_dir() -> None:
    ensure_dir("data")


def make_dt_tag(dt: float) -> str:
    code = int(round(dt * 100.0))
    return f"{code:03d}"


def file_exists(path: str) -> bool:
    return os.path.isfile(path)


def scheme_data_exists(scheme: str, dt: float) -> bool:
    tag = make_dt_tag(dt)
    fname = os.path.join("data", f"{scheme}_{tag}.txt")
    return file_exists(fname)


def last_block_index_and_time(path: str):
    if not file_exists(path):
        return 0, 0.0

    idx = -1
    last_t = 0.0
    with open(path, "r", encoding="utf-8") as f:
        for line in f:
            if line.startswith("# t ="):
                idx += 1
                try:
                    last_t = float(line.split("=")[1].split()[0])
                except Exception:
                    pass

    if idx < 0:
        idx = 0
    return idx, last_t


def latest_time_in_file(path: str) -> float:
    if not file_exists(path):
        return 0.0
    last_t = 0.0
    with open(path, "r", encoding="utf-8") as f:
        for line in f:
            if line.startswith("# t ="):
                try:
                    last_t = float(line.split("=")[1].split()[0])
                except Exception:
                    pass
    return last_t



def load_block_from_file(path: str, idx: int):
    if not file_exists(path):
        return None, None

    block = -1
    x = []
    y = []
    current_t = 0.0

    with open(path, "r", encoding="utf-8") as f:
        for line in f:
            s = line.strip()
            if not s:
                continue
            if s.startswith("# t ="):
                block += 1
                if block > idx:
                    break
                try:
                    current_t = float(s.split("=")[1].split()[0])
                except Exception:
                    pass
                x = []
                y = []
                continue
            if s.startswith("#"):
                continue
            if block == idx:
                parts = s.split()
                if len(parts) >= 2:
                    x.append(float(parts[0]))
                    y.append(float(parts[1]))

    if block < idx:
        return None, None
    return current_t, (np.array(x), np.array(y))
