import os
import numpy as np
import matplotlib.pyplot as plt

from io_utils import (
    create_dir,
    make_dt_tag,
    make_t_tag,
    load_block_from_file,
    write_block_T,
    write_block_error
)

# ============================================================================
# plot: make all pngs for one dt plus convergence
# ============================================================================

def plot(dt: float, t_target: float) -> None:
    tag = make_dt_tag(dt)
    idx = int(round(t_target / 0.1))

    # --- 1) all schemes vs exact (one figure)
    exact_file = os.path.join("data", f"exact_{tag}.txt")
    files = {
        "exact": os.path.join("data", f"exact_{tag}.txt"),
        "ftcs explicit": os.path.join("data", f"ftcs_explicit_{tag}.txt"),
        "dufort": os.path.join("data", f"dufort_{tag}.txt"),
        "ftcs implicit": os.path.join("data", f"ftcs_implicit_{tag}.txt"),
        "cn": os.path.join("data", f"cn_{tag}.txt"),
    }

    t_ex, data_ex, ok_ex = load_block_from_file(exact_file, idx)
    if not ok_ex:
        raise RuntimeError("Could not load exact block. Run sim first.")

    x, y_exact = data_ex

    plt.figure()
    plt.title(f"All schemes vs exact, dt={dt:.3f}, t={t_target:.2f}")
    plt.xlabel("x")
    plt.ylabel("T")
    plt.grid(True)

    plt.plot(x, y_exact, linewidth=2.5, linestyle="--", label="exact")

    for name in ["ftcs explicit", "dufort", "ftcs implicit", "cn"]:
        _, data_s, ok_s = load_block_from_file(files[name], idx)
        if not ok_s:
            continue
        xs, ys = data_s
        plt.plot(xs, ys, marker="o", linewidth=1.5, label=name)

    plt.legend()
    plt.savefig(os.path.join("plot", f"all_schemes_{tag}_t{make_t_tag(t_target)}.png"), dpi=150)

    # --- 2) errors vs exact (one figure)
    plt.figure()
    plt.title(f"Errors vs exact, dt={dt:.3f}, t={t_target:.2f}")
    plt.xlabel("x")
    plt.ylabel("T scheme minus T exact")
    plt.grid(True)

    for name in ["ftcs explicit", "dufort", "ftcs implicit", "cn"]:
        _, data_s, ok_s = load_block_from_file(files[name], idx)
        if not ok_s:
            continue
        xs, ys = data_s
        if len(xs) != len(x):
            continue
        plt.plot(xs, ys - y_exact, marker="o", linewidth=1.5, label=name)

    plt.legend()
    plt.savefig(os.path.join("plot", f"error_schemes_{tag}_t{make_t_tag(t_target)}.png"), dpi=150)

    # --- 3) convergence plot from table (one figure)
    conv_path = os.path.join("data", f"convergence_t{make_t_tag(t_target)}.txt")
    if os.path.isfile(conv_path):
        data = np.loadtxt(conv_path, comments="#")
        dtc = data[:, 0]
        L2_exp, L2_imp, L2_df, L2_cn = data[:, 1], data[:, 2], data[:, 3], data[:, 4]

        plt.figure()
        plt.title(f"Convergence at t={t_target:.2f}")
        plt.xlabel("dt")
        plt.ylabel("L2 error")
        plt.grid(True, which="both")

        plt.loglog(dtc, L2_exp, marker="o", label="L2 exp")
        plt.loglog(dtc, L2_imp, marker="o", label="L2 imp")
        plt.loglog(dtc, L2_df,  marker="o", label="L2 df")
        plt.loglog(dtc, L2_cn,  marker="o", label="L2 cn")

        plt.gca().invert_xaxis()
        plt.legend()
        plt.savefig(os.path.join("plot", f"convergence_t{make_t_tag(t_target)}.png"), dpi=150)
